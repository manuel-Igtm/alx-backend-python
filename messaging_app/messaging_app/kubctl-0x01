#!/bin/bash
# kubctl-0x01
# Script to scale Django app in Kubernetes, verify pods, run load testing, and monitor resources.

# Exit on error
set -e

DEPLOYMENT_NAME="messaging-app-deployment"
NAMESPACE="default"
REPLICAS=3
SERVICE_NAME="messaging-app-service"

echo "üöÄ Scaling deployment '$DEPLOYMENT_NAME' to $REPLICAS replicas..."
kubectl scale deployment $DEPLOYMENT_NAME --replicas=$REPLICAS -n $NAMESPACE

echo "‚úÖ Verifying pods..."
kubectl get pods -n $NAMESPACE -o wide

echo "‚è≥ Waiting for pods to be ready..."
kubectl rollout status deployment/$DEPLOYMENT_NAME -n $NAMESPACE

# Get service URL for minikube (local dev)
echo "üåê Getting service URL..."
APP_URL=$(minikube service $SERVICE_NAME -n $NAMESPACE --url | head -n 1)
echo "App available at: $APP_URL"

# Run load test
echo "‚ö° Running load test with wrk..."
wrk -t2 -c50 -d20s $APP_URL

# Monitor resource usage
echo "üìä Resource usage:"
kubectl top pods -n $NAMESPACE
