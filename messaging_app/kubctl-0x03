#!/bin/bash

set -e

echo "ğŸ“¦ Applying updated deployment (rolling update)..."
kubectl apply -f messaging_app/blue_deployment.yaml

echo "ğŸ”„ Monitoring rollout status..."
kubectl rollout status deployment/messaging-app-blue

echo "ğŸš€ Testing app availability during rollout..."
for i in {1..20}
do
  curl -s http://$(minikube ip):$(kubectl get svc messaging-app-service -o=jsonpath='{.spec.ports[0].nodePort}')/ || echo "âŒ Request failed"
  sleep 1
done

echo "âœ… Rollout complete. Current pods:"
kubectl get pods -l app=messaging-app

